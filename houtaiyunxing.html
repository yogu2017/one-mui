<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="js/mui.min.js"></script>
    <link href="css/mui.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/stele.css" />
    <link rel="stylesheet" href="css/style1.3.13.2.css" />
    <script src="js/castapp.js"></script>
    <style>
        .mmmabwelcome-button {
            width: 60%;
            border-radius: 3px;
            border: 4px solid #fff;
            ;
            height: 30px;
            font-size: 15px;
            text-align: center;
            background: #fff;
            ;
            position: fixed; /*固定位置*/
            left: 35%;
            bottom: 92.3%;
        }
    </style>
</head>
<body>
    <header class="mui-bar mui-bar-nav">
        <h5 class="mui-btn-tit">鑫汉物流</h5>
        <h1 id="btn" class="mui-title du-a">
            <body class="public-white-bgcolor">
                <div class="mmmabwelcome-button">
                    <span class="mui-icon mui-icon-search" style="position: absolute;left: 10%;top:-3px;"></span>
                    <div>搜索</div>
                </div>
        </h1>
        <div class="abwelcome-button">
            <button><div id="aapublic-w-g-button">大</div></button>
            <br /><br />
            <button><div id="bpublic-w-w-button">小</div></button>
        </div>
    </header>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
    <script src="http://120.25.151.20/telecom/script/JQuery/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="http://120.25.151.20/telecom/script/ajax.js"></script>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=5f95bd50a8293568ef0fc8bd63ed9de9"></script>
    <div id='container'></div>

    <script type="text/javascript">
        var map, geolocation;
        var phonew = localStorage.getItem('login_phonew');
        var phone = localStorage.getItem('login_phone');

        var searchID = "";
        var searchMarker = null;
        function showSearch() {
            try {
                var searchData = localStorage.getItem('result_search');
                if (searchData != null && searchData.length > 5) {
                    console.log("get search data: " + searchData);

                    var data = JSON.parse(searchData);
                    if (searchMarker == null) {
                        searchMarker = new AMap.Marker({
                            map: map,
                            position: [data.Longitude, data.Latitude],
                            icon: new AMap.Icon({ size: new AMap.Size(32, 32), image: "img/logo.png" })
                        });
                        map.setCenter(searchMarker.getPosition());
                    } else {
                        searchMarker.setPosition(new AMap.LngLat(data.Longitude, data.Latitude));
                    }

                    searchID = data.Phone;
                    localStorage.setItem('result_search', "");
                }
            } catch (e) {
                console.log("show search error.");
            }
        }

        function getSearchID() {
            console.log("getSearchID-deviceid: " + searchID);
            if (searchID == "") return;

            var deviceid = searchID;
            var type = 1;
            var urlStr = "http://mcpoc.cn:8097/FindDevice?requestData=" + deviceid + "*1";
            $.ajax({
                url: urlStr,
                type: 'get',
                success: function (data) {
                    console.log("searchret: " + data);
                    var data = JSON.parse(data);

                    if (data.result == "false") {
                        searchID == "";
                        console.log("终止查询, 没有该号码的位置信息!");
                        return;
                    } else if (parseInt(data.Status) == 1) {
                        searchID == "";
                        console.log("终止查询, 对方关闭位置共享!");                        
                        return;
                    }

                    console.log("位置信息查找成功.");
                    if (searchMarker == null) {
                        searchMarker = new AMap.Marker({
                            map: map,
                            position: [data.Longitude, data.Latitude],
                            icon: new AMap.Icon({ size: new AMap.Size(32, 32), image: "img/logo.png" })
                        });
                        map.setCenter(searchMarker.getPosition());
                    } else {
                        searchMarker.setPosition(new AMap.LngLat(data.Longitude, data.Latitude));
                    }
                },
                error: function (e) {
                    console.log("位置信息查找异常.");
                }
            });
        }

        // 上传位置
        function uploadEntity(entity) {
            var urlStr = "http://mcpoc.cn:8097/UploadPos?requestData=";
            var urlData = entity.Phone + "*" + entity.UserName + "*" + entity.lat + "*" + entity.lon + "*" + entity.speed + "*" + entity.aspect +
                    "*" + entity.gTime + "*" + entity.sta + "*" + entity.Mileage + "*" + entity.OilValue + "*" + entity.BaseStation;

            //     console.log("RequestData: " + urlStr + urlData);
            $.ajax({
                url: urlStr + urlData,
                type: 'get',
                success: function (data) {
                    //console.log("upload ret:" + JSON.stringify(data));
                },
                error: function (e) {
                    console.log("get data error.");
                }
            });
        }

       
        // 解析定位结果
       var timeSpan =3000;			// 默认3秒定一次位置
        function onComplete(data) {
            var entity = {};
            entity.Phone = phone;   // 填号码或登录帐号
            entity.UserName = phonew;		// 填车牌

            entity.lat = data.position.getLat();
            entity.lon = data.position.getLng();
            entity.speed = 0;
            entity.aspect = 0;

            var myDate = new Date();
            entity.gTime = myDate.getFullYear() + "-" + myDate.getMonth() + "-" + myDate.getDate() + " " + myDate.getHours() + ":" + myDate.getMinutes() + ":" + myDate.getSeconds();
            entity.Mileage = data.accuracy;
            entity.BaseStation = data.isConverted ? 1 : 0;
            var sta = localStorage.getItem('CurSta');		// 从缓存中获取标记
            if (sta == undefined) sta = 0;						// 默认是开启定位
            entity.sta = sta;
            entity.OilValue = 0;

            showMyPosition(entity.lon, entity.lat);
            uploadEntity(entity);

            console.log("定位成功, data:" + entity.lat + "-" + entity.lon + ", " + timeSpan/1000 +"秒后继续定位");
            setTimeout(function () { geolocation.getCurrentPosition(); }, timeSpan);
            //		 console.log(data)
            //       alert( JSON.stringify(data) );

            showSearch();
        }
        // 解析定位错误信息
//      function onError() {
//          //document.getElementById('tip').innerHTML = '定位失败';
//          console.log("定位失败, " + timeSpan + "秒后继续定位");
//          setTimeout(function () { geolocation.getCurrentPosition(); }, timeSpan);
//      }

        // 显示自己的位置
        var customMarker = null;
        function showMyPosition(x, y) {
           // console.log("show my pos-x:" + x + ", y:" + y);

            if (customMarker == null) {
                customMarker = new AMap.Marker({
                    map: map,
                    position: [x, y],
               icon: new AMap.Icon({ size: new AMap.Size(32,32), image: "img/logo.png" })
                });
                map.setCenter(customMarker.getPosition());
            } else {
                customMarker.setPosition(new AMap.LngLat(x, y));
            }
        }
        
        mui.init();
        var btn = document.getElementById('btn');
        btn.onclick = function () {
            mui.openWindow({
                url: 'sousuo.html', //需要打开页面的url地址
                id: 'sousuo',  //需要打开页面的url页面id
              
                waiting: { // 控制 弹出转圈框的信息
                    autoShow: false,//自动显示等待框，默认为true false
                  
                }
            })
        }

     
        //加载地图，调用浏览器定位服务

           var map, geolocation;
        map = new AMap.Map('container', {
            resizeEnable: true

        });
        map.plugin('AMap.Geolocation', function () {
            geolocation = new AMap.Geolocation({
           enableHighAccuracy: true,//是否使用高精度定位，默认:true
         timeout: 10000,          //超过10秒后停止定位，默认：无穷大
        maximumAge: 0,           //定位结果缓存0毫秒，默认：0
        convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
        showButton: true,        //显示定位按钮，默认：true
        buttonPosition: 'RB',    //定位按钮停靠位置，默认：'LB'，左下角
        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
        showMarker: false,        //定位成功后在定位到的位置显示点标记，默认：true
        showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
        panToLocation:false,     //定位成功后将定位到的位置作为地图中心点，默认：true
        zoomToAccuracy:false      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                
            });
            map.addControl(geolocation);
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
            AMap.event.addListener(geolocation, 'error', onError);  //返回定位出错信息
        });

        (function () {
            document.getElementById('aapublic-w-g-button').onclick = function () {
                map.zoomIn();
            };
            document.getElementById('bpublic-w-w-button').onclick = function () {
                map.zoomOut();
            };
        })();
        
function plusReady(){
	// 开启一直保持程序唤醒状态
	plus.device.setWakelock( true );
}
if(window.plus){
	plusReady();
}else{
	document.addEventListener("plusready",plusReady,false);
}
        setInterval(function () { getSearchID(); }, timeSpan);
    </script>
    <script src="html5plus://ready">
var main = plus.android.runtimeMainActivity();
main.moveTaskToBack(false);
</script>
</body>
</html>                                